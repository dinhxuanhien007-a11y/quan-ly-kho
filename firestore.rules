rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- CÁC HÀM HELPER ---
    function isOwner() {
      return request.auth.token.role == 'owner';
    }
    // Bỏ hàm isManager() không dùng đến để cho gọn
    function isSignedIn() {
      return request.auth != null;
    }

    // --- QUẢN LÝ USER ---
    match /allowlist/{email} {
      allow read, write: if isOwner();
    }

    match /users/{userId} {
      allow list: if isOwner(); // Chỉ owner mới được list
      allow read: if isSignedIn() && (request.auth.uid == userId || isOwner());
      allow write: if isOwner();
    }

    // --- DỮ LIỆU CỐT LÕI ---
    match /products/{docId} {
      allow read: if isSignedIn();
      allow write: if isOwner();
    }
    match /partners/{docId} {
      allow read: if isSignedIn();
      allow write: if isOwner();
    }
    match /inventory_lots/{docId} {
      allow read: if isSignedIn();
      allow write: if isOwner();
    }
    match /product_summaries/{docId} {
      allow read: if isSignedIn();
      allow write: if false; // Chặn ghi từ client, kể cả owner
    }

    // --- PHIẾU NHẬP/XUẤT ---
    match /import_tickets/{ticketId} {
      allow read: if isOwner();
      allow write: if isOwner();
    }
    match /export_tickets/{ticketId} {
      allow read: if isOwner();
      allow write: if isOwner();
    }
    
    // --- DỮ LIỆU DASHBOARD ---
    match /dailyActivity/{docId} {
        allow read: if isOwner();
        allow write: if false;
    }
    match /dashboardStats/{docId} {
        allow read: if isOwner();
        allow write: if false;
    }

    // --- CẢNH BÁO & KIỂM KÊ ---
    // Gộp 2 rule cũ thành 1 rule đúng duy nhất
    match /notifications/{notificationId} {
      allow read, write, delete: if isOwner();
    }
    
    match /stocktakes/{sessionId} {
      allow read, write: if isOwner();
      match /items/{itemId} {
        allow read, write: if isOwner();
      }
    }
    
    // --- ĐIỀU CHỈNH KHO ---
    match /inventory_adjustments/{adjustmentId} {
      allow read: if isSignedIn();
      allow create: if isOwner();
    }

  } // Đóng match /databases/{database}/documents
}